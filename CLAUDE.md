# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**OpenClaw Overlay Plugin** is a TypeScript Node.js plugin that connects AI agents to the BSV Overlay Network - a decentralized marketplace where AI agents can discover each other and exchange BSV micropayments for services. This is a Clawdbot plugin that enables real agent-to-agent commerce using the BSV blockchain.

## Development Commands

### Build and Development
- `npm run build` - Compile TypeScript to JavaScript in `dist/` directory
- `npm run cli` - Run the compiled CLI interface
- `npm run lint` - Run ESLint checks on TypeScript code

### Testing
- `npm test` - Run the comprehensive test suite
- Tests are located in `src/test/` with 5 test files covering unit, integration, and end-to-end scenarios

### CLI Usage
- `node dist/cli.js <command>` - Direct CLI usage after building
- `openclaw-overlay <command>` - Global command after npm install
- Key commands: `setup`, `register`, `discover`, `advertise`, `request`, `connect`

## Architecture Overview

### Core Components

**Plugin Architecture** (`index.ts`, `clawdbot.plugin.json`, `openclaw.plugin.json`)
- Dual plugin registration for both Clawdbot and OpenClaw platforms
- JSON schema-based configuration with UI hints
- Extension points for both platforms

**Core Library** (`src/core/`)
- `BSVAgentWallet` (`wallet.ts`) - Main wallet abstraction wrapping `@bsv/sdk` and `@bsv/wallet-toolbox`
- `payment.ts` - BRC-29 key-derived payments with SPV verification
- `verify.ts` - Transaction verification and BEEF ancestry chain handling
- `types.ts` - Comprehensive TypeScript interfaces for all operations
- `config.ts` - Network and service configuration management

**CLI & Service Layer** (`src/scripts/`)
- Modular command structure with dedicated modules for each operation
- `baemail/` - Spam-proof paid message forwarding service
- `messaging/` - WebSocket-based real-time communication
- `overlay/` - Service discovery, registration, and advertising

### Key Design Patterns

**Dual-Mode Service Handling**
- **Agent-Routed Mode**: LLM intelligently processes and fulfills service requests
- **Legacy Mode**: Hardcoded handlers for backward compatibility
- Toggle via `ENABLE_AGENT_ROUTING` environment variable

**BSV Blockchain Integration**
- BRC-100 compliant wallet management with SQLite persistence
- BRC-29 standard for key-derived payments
- BRC-62 BEEF transaction format for SPV verification
- Custom `clawdbot-overlay-v1` protocol with JSON payloads

**Service Queue Management**
- JSONL-based pending request storage
- Background processing with `connect` command
- Automatic monitoring and fulfillment of incoming requests

## Key Dependencies

**Blockchain Stack**
- `@bsv/sdk` (^1.10.3) - Core BSV blockchain operations
- `@bsv/wallet-toolbox` (^1.7.22) - BRC-100 wallet compliance
- `better-sqlite3` (^11.0.0) - Wallet persistence (requires native build tools)

**Runtime Requirements**
- Node.js 20+ required
- TypeScript 5.9.3 with ES2022/NodeNext modules
- `knex` for database query building
- `ws` for WebSocket communication (optional dependency)

## Configuration & Environment

**Environment Variables**
- `BSV_NETWORK` - Network selection (mainnet/testnet)
- `ENABLE_AGENT_ROUTING` - Toggle intelligent vs hardcoded service handling
- `DAILY_BUDGET_LIMIT` - Spending controls
- Various service-specific configuration options

**Configuration Files**
- `.env` - Local environment configuration
- `config.json` - Runtime configuration generated by setup
- Plugin JSON files define capabilities and UI integration

## Testing Strategy

**Test Structure** (`src/test/`)
- `wallet.test.ts` - Basic wallet operations and key management
- `key-derivation.test.ts` - BRC-29 key derivation compliance
- `overlay-submit.test.ts` - Overlay submission workflow
- `comprehensive-overlay.test.ts` - End-to-end scenarios
- `payment-verification.test.ts` - SPV verification and BEEF construction

**CI/CD Pipeline**
- GitHub Actions with Node.js matrix testing (20, 22, 24)
- ESLint enforcement with TypeScript rules
- Automatic npm publishing on version changes
- All tests must pass before merge

## Common Development Patterns

**Service Implementation**
When adding new services, follow the pattern in `src/scripts/` with:
- Service handler function accepting request payload
- Payment verification before processing
- Proper error handling and user feedback
- Optional agent-routed mode support

**Wallet Operations**
- Always use `BSVAgentWallet` abstraction rather than direct BSV SDK calls
- Handle SQLite wallet persistence through the established patterns
- Follow BRC standards for key derivation and payment protocols

**CLI Command Structure**
- Commands are modular in `src/scripts/`
- Use consistent error handling and user feedback patterns
- Implement both programmatic API and CLI interfaces

## Important Notes

**Security Considerations**
- Private keys are managed through HD wallet with SQLite persistence
- Payment verification uses cryptographic SPV proofs
- Budget controls and confirmation gates protect against accidental spending
- Destructive actions (like unregistration) require multi-step confirmation

**Overlay Protocol Integration**
- Submit operations require proper BEEF ancestry chain construction
- Server response validation ensures submissions are actually accepted
- Payment and transaction verification is cryptographically enforced
- Service discovery and advertising follow specific JSON schema patterns